# Timeout Auto-Recovery Test Workflow
#
# This workflow tests the automatic timeout recovery feature of `torc watch --auto-recover`.
#
# Setup:
# - 2 jobs that each specify 5 minutes runtime in resource requirements
# - job_fast completes in 1 minute (succeeds)
# - job_slow runs for 10 minutes (exceeds 5 min runtime and 8 min walltime)
# - Slurm scheduler with 8 minute walltime
#
# Test procedure:
# 1. Submit the workflow: torc submit-slurm --account <account> workflow.yaml
# 2. Watch with auto-recover: torc watch <workflow_id> --auto-recover
# 3. job_slow will be killed by Slurm at ~8 minutes (walltime exceeded)
# 4. Watcher detects timeout and increases runtime (5min -> 7.5min -> 11.25min)
# 5. Scheduler regenerates with longer walltime
# 6. On retry, job_slow completes successfully

name: timeout_auto_recovery_test
description: Test workflow for automatic timeout recovery

resource_requirements:
  - name: job_resources
    num_cpus: 1
    memory: 1g
    runtime: PT5M  # 5 minutes

jobs:
  - name: job_fast
    command: |
      echo "Fast job starting at $(date)"
      echo "This job will complete quickly (1 minute)"
      sleep 60
      echo "Fast job completed at $(date)"
    resource_requirements: job_resources

  - name: job_slow
    command: |
      echo "Slow job starting at $(date)"
      echo "This job will run for 10 minutes (exceeds 5 min runtime and 8 min walltime)"
      echo "It should be killed by Slurm and recovered by the watcher"
      for i in $(seq 1 10); do
        echo "Minute $i of 10..."
        sleep 60
      done
      echo "Slow job completed at $(date)"
    resource_requirements: job_resources

schedulers:
  - name: job_scheduler
    scheduler_type: slurm
    account: PLACEHOLDER_ACCOUNT
    partition: debug
    walltime: "00:08:00"  # 8 minutes - job_slow will exceed this
    mem: 2g
    num_nodes: 1
    job_filter:
      resource_requirements:
        - job_resources

actions:
  - trigger_type: on_workflow_start
    action_type: schedule_nodes
    parameters:
      scheduler: job_scheduler
      num_nodes: 2
