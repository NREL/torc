# Recovery Hook Test Workflow
#
# This workflow tests the --recovery-hook feature of `torc watch`.
#
# Setup:
# - 5 work jobs (work_1 through work_5) that each need 10GB memory and 30 CPUs
# - 1 postprocess job that runs after all work jobs complete
# - work_3 will fail on first run because it requires a file that doesn't exist
#
# Test procedure:
# 1. Submit the workflow: torc submit-slurm --account <account> workflow.yaml
# 2. Watch with recovery hook: torc watch <workflow_id> --auto-recover --recovery-hook "bash create_missing_file.sh"
# 3. work_3 will fail, recovery hook creates the missing file, workflow retries and succeeds
#
# The recovery hook script (create_missing_file.sh) creates the required file.

name: recovery_hook_test
description: Test workflow for --recovery-hook feature

resource_requirements:
  - name: work_resources
    num_cpus: 30
    memory: 10g
    runtime: PT30M
  - name: postprocess_resources
    num_cpus: 1
    memory: 1g
    runtime: PT10M

jobs:
  - name: work_1
    command: |
      echo "Work job 1 starting"
      sleep 5
      echo "Work job 1 completed successfully"
    resource_requirements: work_resources

  - name: work_2
    command: |
      echo "Work job 2 starting"
      sleep 5
      echo "Work job 2 completed successfully"
    resource_requirements: work_resources

  - name: work_3
    command: |
      echo "Work job 3 starting"
      REQUIRED_FILE="$TORC_OUTPUT_DIR/required_input.txt"
      if [ ! -f "$REQUIRED_FILE" ]; then
        echo "ERROR: Required file not found: $REQUIRED_FILE"
        echo "This job requires the file to be created by the recovery hook."
        exit 1
      fi
      echo "Found required file: $(cat $REQUIRED_FILE)"
      sleep 5
      echo "Work job 3 completed successfully"
    resource_requirements: work_resources

  - name: work_4
    command: |
      echo "Work job 4 starting"
      sleep 5
      echo "Work job 4 completed successfully"
    resource_requirements: work_resources

  - name: work_5
    command: |
      echo "Work job 5 starting"
      sleep 5
      echo "Work job 5 completed successfully"
    resource_requirements: work_resources

  - name: postprocess
    command: |
      echo "Postprocess job starting"
      echo "All work jobs completed, running final aggregation..."
      sleep 2
      echo "Postprocess completed successfully"
    resource_requirements: postprocess_resources
    depends_on:
      - work_1
      - work_2
      - work_3
      - work_4
      - work_5

slurm_schedulers:
  - name: job_scheduler
    account: PLACEHOLDER_ACCOUNT
    partition: debug
    walltime: "01:00:00"
    mem: 240g
    num_nodes: 1

actions:
  - trigger_type: "on_workflow_start"
    action_type: "schedule_nodes"
    scheduler: "job_scheduler"
    scheduler_type: "slurm"
    num_allocations: 1
