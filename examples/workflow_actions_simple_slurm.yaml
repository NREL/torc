name: "Simple Workflow with Actions"
user: "demo"
description: "Demonstrates scheduler actions for different workflow stages"

jobs:
  - name: "setup"
    command: "echo 'Setting up...' && sleep 2"
    resource_requirements_name: "small"

  - name: "process"
    command: "echo 'Processing data...' && sleep 5"
    blocked_by_job_names: ["setup"]
    resource_requirements_name: "medium"

  - name: "finalize"
    command: "echo 'Finalizing...' && sleep 2"
    blocked_by_job_names: ["process"]
    resource_requirements_name: "small"

resource_requirements:
  - name: "small"
    num_cpus: 2
    num_gpus: 0
    num_nodes: 1
    memory: "4g"
    runtime: "PT30M"

  - name: "medium"
    num_cpus: 8
    num_gpus: 0
    num_nodes: 1
    memory: "16g"
    runtime: "PT2H"

slurm_schedulers:
  # Small scheduler for setup stage
  - name: "setup_scheduler"
    account: "demo_project"
    partition: "short"
    nodes: 1
    walltime: "00:30:00"
    mem: "4G"

  # Larger scheduler for compute-intensive processing stage
  - name: "process_scheduler"
    account: "demo_project"
    partition: "compute"
    nodes: 2
    walltime: "02:00:00"
    mem: "16G"

  # Medium scheduler for finalization stage
  - name: "finalize_scheduler"
    account: "demo_project"
    partition: "short"
    nodes: 1
    walltime: "00:30:00"
    mem: "8G"

actions:
  # Run setup commands when the workflow starts
  - trigger_type: "on_workflow_start"
    action_type: "run_commands"
    commands:
      - "echo 'Workflow started at $(date)' > workflow_log.txt"
      - "mkdir -p output temp"
      - "echo 'Environment ready'"

  # Allocate resources for setup stage
  - trigger_type: "on_workflow_start"
    action_type: "schedule_nodes"
    job_names: ["setup"]
    scheduler_name: "setup_scheduler"
    scheduler_type: "slurm"
    num_allocations: 1
    start_one_worker_per_node: true
    max_parallel_jobs: 1

  # Allocate resources for processing stage
  - trigger_type: "on_jobs_ready"
    action_type: "schedule_nodes"
    job_names: ["process"]
    scheduler_name: "process_scheduler"
    scheduler_type: "slurm"
    num_allocations: 2
    start_one_worker_per_node: true
    max_parallel_jobs: 2

  # Allocate resources for finalization stage
  - trigger_type: "on_jobs_ready"
    action_type: "schedule_nodes"
    job_names: ["finalize"]
    scheduler_name: "finalize_scheduler"
    scheduler_type: "slurm"
    num_allocations: 1
    start_one_worker_per_node: true
    max_parallel_jobs: 1

  # Run cleanup when the workflow completes
  - trigger_type: "on_workflow_complete"
    action_type: "run_commands"
    commands:
      - "echo 'Workflow completed at $(date)' >> workflow_log.txt"
      - "echo 'Cleaning up temporary files...'"
      - "rm -rf temp"
      - "echo 'Archiving results...'"
      - "tar -czf output/results.tar.gz workflow_log.txt"
      - "echo 'Workflow cleanup complete'"
